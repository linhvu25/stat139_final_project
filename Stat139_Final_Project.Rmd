---
title: "Stat139_Final_Project"
author: 
  - "Brice Laurent"
  - "Linh Vu"
  - "Aissata Bah"
date: "2023-11-30"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,message=F}
# Load Libraries
library(reshape2)
library(dplyr)
library(ggplot2)
library(vtree)

# Load Data
HDR = read.csv("./data/HDR.csv")
ROL = read.csv("./data/ROL.csv")
```

```{r, warning=F}
# Clean Data
ROL_countries = unique(ROL$Country.Code)
HDR_countries = unique(HDR$iso3)

ROL_countries[!ROL_countries%in%HDR_countries]
HDR_countries[!HDR_countries%in%ROL_countries]

# Remove Countries that are not include in both datasets
shared_countries = ROL_countries[ROL_countries!= c("XKX","")]
ROL_clean = ROL[ROL$Country.Code%in%shared_countries,]
HDR_clean = HDR[HDR$iso3%in%shared_countries,]

# Format HDR
HDR_clean = HDR_clean[,!(names(HDR_clean)==c("hdicode","region"))]
HDR_clean_melt = melt(HDR_clean)
HDR_clean_melt$variable = as.character(HDR_clean_melt$variable)
HDR_clean_melt$year = as.numeric(substr(HDR_clean_melt$variable, nchar(HDR_clean_melt$variable) - 3, nchar(HDR_clean_melt$variable)))
HDR_clean_melt$variable = substr(HDR_clean_melt$variable, 1, nchar(HDR_clean_melt$variable) - 5)
HDR_clean_cast = dcast(HDR_clean_melt, iso3 + country + year ~variable)

# Fix Year Data
HDR_clean_cast$year = as.character(HDR_clean_cast$year)
calculate_average <- function(data, start_year, end_year) {
  data %>%
    filter(year >= start_year & year <= end_year) %>%
    group_by(iso3) %>%
    summarise(across(-c(year, country), mean, na.rm = TRUE))
}
averages_20122013 = calculate_average(HDR_clean_cast, 2012,2013)
averages_20122013$year = "2012-2013"
averages_20122013 = merge(averages_20122013, unique(HDR_clean_cast[, c("iso3","country")]), by = "iso3")
averages_20172018 = calculate_average(HDR_clean_cast, 2017,2018)
averages_20172018$year = "2017-2018"
averages_20172018 = merge(averages_20172018, unique(HDR_clean_cast[, c("iso3","country")]), by = "iso3")

HDR_clean_cast = rbind(HDR_clean_cast, averages_20122013, averages_20172018)

# Merge HDR and ROL
merged = inner_join(HDR_clean_cast, ROL_clean, by = c("iso3" = "Country.Code", "year" = "Year"))

# Remove columns with more thn 10% NA values
keep <- colMeans((is.na(merged))) < 0.1
data <- merged[, names(keep)[keep]]
data$year <- as.ordered(data$year)

# Rename columns
colnames(data) <- tolower(colnames(data))
colnames(data)[37:89] <- substring(colnames(data)[37:89],1,8)

for(i in 37:89){
  if(substring(colnames(data)[i],1,1) == "x"){
    colnames(data)[i] <- substring(colnames(data)[i],1,nchar(colnames(data)[i])-4)
  }
}

data = data[,!(names(data)==c("Country","Country_year", "country.1", "country_year"))]

write.csv(data,"./data/data_clean.csv")
```

```{r}
data <- read.csv("./data/data_clean.csv")

# structure of dataset
vtree(data, "year")
vtree(data, "region")

# histogram
ggplot(aes(hdi), data=data) +
  geom_histogram(col="white") +
    labs(title="Distribution of HDI")

ggplot(aes(hdi), data=data) + 
  facet_wrap(~Region) +
  geom_histogram(col="white") +
  labs(title="Distribution of HDI by Regions")

# scatter plot
ggplot(aes(wjp.rule, hdi, color=Region), data=data) +
  geom_point() +
  labs(title="HDI vs ROL index, by Regions")

ggplot(aes(wjp.rule, hdi, color=Region), data=data) +
  geom_point() +
  labs(title="ROL index vs HDI, by Regions")

# boxplot
ggplot(aes(Region, hdi), data=data) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 25, hjust=1)) +
  labs(title="How HDIs vary across Regions")

ggplot(aes(Region, wjp.rule), data=data) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 25, hjust=1)) +
  labs(title="How ROL indices vary across Regions")

# spaghetti plot
ggplot(aes(year, wjp.rule, group = country, col=Region), data=data) +
  geom_line() +
  labs(title="ROL over time across Regions")

ggplot(aes(year, hdi, group = country, col=Region), data=data) +
  geom_line() +
  labs(title="HDI over time across Regions")

# correlation heatmap
cormat <- round(cor(data[,!(names(data)%in%c("iso3","country","year","region"))], use = "na.or.complete"),2)
melted_cormat <- melt(cormat)
ggplot(data = melted_cormat, aes(x=Var1, y=Var2, fill=value)) +  
  geom_tile(color = "white")+
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", midpoint = 0, limit = c(-1,1), space = "Lab", name="Pearson\nCorrelation") +
  theme(axis.text.x=element_blank(), axis.ticks.x=element_blank(), axis.text.y=element_blank(), axis.ticks.y=element_blank()) +
  ggtitle("Correlation Heatmap, all Variables")
```

